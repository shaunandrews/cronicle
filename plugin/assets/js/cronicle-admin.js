(()=>{"use strict";const e=window.React,t=window.wp.element,n=window.wp.i18n,a={messages:[],currentDraft:null,currentSessionId:null,selectedMode:"draft",isTyping:!1,isSending:!1,showPreview:!1,showWelcome:!0},c="ADD_MESSAGE",l="SET_CURRENT_DRAFT",s="SET_SESSION_ID",r="SET_MODE",o="SET_TYPING",i="SET_SENDING",d="SET_SHOW_PREVIEW",u="CLEAR_MESSAGES",m="LOAD_MESSAGES",p=(e,t)=>{switch(t.type){case c:return{...e,messages:[...e.messages,t.payload],showWelcome:!1};case l:return{...e,currentDraft:t.payload};case s:return{...e,currentSessionId:t.payload};case r:return{...e,selectedMode:t.payload};case o:return{...e,isTyping:t.payload};case i:return{...e,isSending:t.payload};case d:return{...e,showPreview:t.payload};case"SET_SHOW_WELCOME":return{...e,showWelcome:t.payload};case u:return{...e,messages:[],currentDraft:null,showWelcome:!0,showPreview:!1};case m:return{...e,messages:t.payload,showWelcome:0===t.payload.length};default:return e}},y=(0,t.createContext)(),_=({children:n})=>{const[c,l]=(0,t.useReducer)(p,a);return(0,e.createElement)(y.Provider,{value:{state:c,dispatch:l}},n)},h=()=>{const e=(0,t.useContext)(y);if(!e)throw new Error("useCronicle must be used within a CronicleProvider");return e},E=async e=>(await fetch(window.cronicle_ajax.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({...e,nonce:window.cronicle_ajax.nonce})})).json(),g=({isApiConfigured:t})=>{let a={selectedMode:"draft"},l=()=>{};if(t)try{const e=h();a=e.state,l=e.dispatch}catch(e){}return(0,e.createElement)("div",{className:"cronicle-header"},(0,e.createElement)("h1",null,(0,n.__)("Cronicle AI Assistant","cronicle")),(0,e.createElement)("div",{className:"cronicle-header-right"},t&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"cronicle-session-controls"},(0,e.createElement)("button",{type:"button",className:"button cronicle-new-session-btn",onClick:async()=>{if(window.confirm((0,n.__)("Start a new chat session? This will clear the current conversation.","cronicle")))try{const e=await(async()=>E({action:"cronicle_start_new_session"}))();e.success&&(l({type:s,payload:e.data.session_id}),l({type:u}),l({type:c,payload:{type:"system",content:e.data.message,timestamp:(new Date).getTime()}}),setTimeout(()=>{},2e3))}catch(e){alert((0,n.__)("Could not start new session. Please try again.","cronicle"))}}},(0,n.__)("New Chat","cronicle"))),(0,e.createElement)("div",{className:"cronicle-mode-selector"},(0,e.createElement)("label",{htmlFor:"cronicle-mode-select"},(0,n.__)("Mode:","cronicle")),(0,e.createElement)("select",{id:"cronicle-mode-select",className:"cronicle-mode-select",value:a.selectedMode||"draft",onChange:e=>{l&&l({type:r,payload:e.target.value})}},(0,e.createElement)("option",{value:"draft"},(0,n.__)("Full Draft","cronicle")),(0,e.createElement)("option",{value:"outline"},(0,n.__)("Outline","cronicle"))))),(0,e.createElement)("span",{className:"cronicle-status "+(t?"connected":"disconnected")},t?(0,n.__)("Connected","cronicle"):(0,n.__)("Not Connected","cronicle"))))},w=({postData:a,onPreview:c,fromHistory:s})=>{const{dispatch:r}=h();return(0,t.useEffect)(()=>{if(!s&&a){const e=setTimeout(()=>{r({type:l,payload:a}),r({type:d,payload:!0})},500);return()=>clearTimeout(e)}},[a,s,r]),(0,e.createElement)("div",{className:"cronicle-post-actions"},(0,e.createElement)("button",{className:"button button-secondary",onClick:c,style:{padding:"8px 16px",fontSize:"13px"}},(0,n.__)("Preview","cronicle")))},f=({message:t})=>{const{dispatch:n}=h();return"system"===t.type?(0,e.createElement)("div",{className:"cronicle-message system"},(0,e.createElement)("div",{className:"cronicle-message-content"},(0,e.createElement)("em",null,t.content)),(0,e.createElement)("div",{style:{clear:"both"}})):(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:`cronicle-message ${t.type}`},(0,e.createElement)("div",{className:"cronicle-message-content"},t.content,t.is_post_content&&t.post_data&&(0,e.createElement)(w,{postData:t.post_data,onPreview:()=>{t.post_data&&(n({type:l,payload:t.post_data}),n({type:d,payload:!0}))},fromHistory:t.fromHistory}))),(0,e.createElement)("div",{style:{clear:"both"}}))},v=({messages:n})=>{const a=(0,t.useRef)(null);return(0,t.useEffect)(()=>{a.current?.scrollIntoView({behavior:"smooth"})},[n]),(0,e.createElement)("div",{className:"cronicle-messages"},n.map((t,n)=>(0,e.createElement)(f,{key:`${t.timestamp||Date.now()}-${n}`,message:t})),(0,e.createElement)("div",{ref:a}))},b=()=>{const{state:a,dispatch:s}=h(),[r,d]=(0,t.useState)(""),u=(0,t.useRef)(null),m=()=>{const e=u.current;if(!e)return;e.style.height="auto";let t=e.scrollHeight;if(!r){const n=document.createElement("div"),a=window.getComputedStyle(e);n.style.position="absolute",n.style.visibility="hidden",n.style.padding=a.padding,n.style.width=a.width,n.style.fontFamily=a.fontFamily,n.style.fontSize=a.fontSize,n.style.lineHeight=a.lineHeight,n.style.whiteSpace="pre-wrap",n.style.wordWrap="break-word",n.textContent=e.placeholder,document.body.appendChild(n),t=n.scrollHeight,document.body.removeChild(n)}const n=Math.min(t,300);e.style.height=`${n}px`,e.style.overflowY=t>300?"auto":"hidden"};(0,t.useEffect)(()=>{m()},[r]),(0,t.useEffect)(()=>{if(u.current){const e="outline"===a.selectedMode?(0,n.__)("What topic would you like an outline for? (e.g., benefits of exercise, cooking tips, travel destinations)","cronicle"):(0,n.__)("What would you like to write about? (e.g., benefits of exercise, cooking tips, travel destinations)","cronicle");u.current.placeholder=e,m()}},[a.selectedMode]);const p=async e=>{e.preventDefault();const t=r.trim();if(t&&!a.isSending){s({type:c,payload:{type:"user",content:t,timestamp:(new Date).getTime()}}),d(""),s({type:i,payload:!0}),s({type:o,payload:!0});try{let e;if(e=a.currentDraft?await(async({title:e,content:t,instructions:n})=>E({action:"cronicle_revise_draft",title:e,content:t,instructions:n}))({title:a.currentDraft.title,content:a.currentDraft.content,instructions:t}):await(async({message:e,mode:t})=>E({action:"cronicle_chat_message",message:e,mode:t}))({message:t,mode:a.selectedMode||"draft"}),e.success&&e.data.content){const t={type:"assistant",content:e.data.content,timestamp:(new Date).getTime(),is_post_content:e.data.is_post_content||!1,post_data:e.data.post_data||null};s({type:c,payload:t}),e.data.is_post_content&&e.data.post_data&&s({type:l,payload:e.data.post_data})}else{const t=e.data?.message||(0,n.__)("Error sending message. Please try again.","cronicle");s({type:c,payload:{type:"assistant",content:`Error: ${t}`,timestamp:(new Date).getTime()}})}}catch(e){s({type:c,payload:{type:"assistant",content:`Error: ${(0,n.__)("Error sending message. Please try again.","cronicle")}`,timestamp:(new Date).getTime()}})}finally{s({type:i,payload:!1}),s({type:o,payload:!1}),u.current&&u.current.focus()}}};return(0,e.createElement)("div",{className:"cronicle-input-area"},(0,e.createElement)("form",{className:"cronicle-input-form",onSubmit:p},(0,e.createElement)("textarea",{ref:u,className:"cronicle-input",value:r,onChange:e=>{d(e.target.value)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),p(e))},placeholder:(0,n.__)("What would you like to write about? (e.g., benefits of exercise, cooking tips, travel destinations)","cronicle"),rows:"1"}),(0,e.createElement)("button",{type:"submit",className:"cronicle-send-button",disabled:a.isSending},a.isSending?(0,n.__)("Sending...","cronicle"):(0,n.__)("Send","cronicle"))))},C=()=>{const{state:a,dispatch:c}=h();return(0,t.useEffect)(()=>{(async()=>{try{const e=await(async()=>E({action:"cronicle_load_chat_history"}))();e.success&&e.data.messages&&(c({type:s,payload:e.data.session_id}),c({type:m,payload:e.data.messages}))}catch(e){console.log("Could not load chat history:",e)}})()},[c]),(0,e.createElement)("div",{className:"cronicle-chat-container"},a.showWelcome&&(0,e.createElement)("div",{className:"cronicle-welcome-message"},(0,n.__)("Create a new draft with AI","cronicle")),(0,e.createElement)(v,{messages:a.messages}),a.isTyping&&(0,e.createElement)("div",{className:"cronicle-typing-indicator"},(0,n.__)("Assistant is typing...","cronicle")),(0,e.createElement)(b,null))},S=({postData:t})=>{if(!t||!t.title||!t.content)return null;const n=(e=>{const t=document.createElement("div");t.innerHTML=e;let n="";return t.querySelectorAll("*").forEach(e=>{const t=e.tagName.toLowerCase(),a=e.textContent.trim();if(a)switch(t){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":n+=`<${t}>${a}</${t}>`;break;case"p":n+=`<p>${a}</p>`;break;case"ul":n+="<ul>",e.querySelectorAll("li").forEach(e=>{n+=`<li>${e.textContent}</li>`}),n+="</ul>";break;case"ol":n+="<ol>",e.querySelectorAll("li").forEach(e=>{n+=`<li>${e.textContent}</li>`}),n+="</ol>"}}),n||(n=e.replace(/\n/g,"<br>")),n})(t.content);return(0,e.createElement)("div",{className:"cronicle-preview-content"},(0,e.createElement)("div",{className:"cronicle-preview-post"},(0,e.createElement)("h1",null,t.title),(0,e.createElement)("div",{dangerouslySetInnerHTML:{__html:n}})))},N=({onConfirm:a,onCancel:c})=>{const[l,s]=(0,t.useState)(""),r=(0,t.useRef)(null);return(0,t.useEffect)(()=>{r.current&&r.current.focus();const e=e=>{"Escape"===e.key&&c()};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[c]),(0,e.createElement)("div",{className:"cronicle-schedule-overlay",onClick:e=>{e.target===e.currentTarget&&c()}},(0,e.createElement)("div",{className:"cronicle-schedule-dialog"},(0,e.createElement)("label",{htmlFor:"schedule-datetime"},(0,n.__)("Select publish date/time","cronicle")),(0,e.createElement)("input",{ref:r,id:"schedule-datetime",type:"datetime-local",className:"cronicle-schedule-input",value:l,onChange:e=>s(e.target.value)}),(0,e.createElement)("div",{style:{display:"flex",gap:"8px",marginTop:"10px"}},(0,e.createElement)("button",{className:"button button-primary cronicle-schedule-confirm",onClick:()=>{l?a(l):alert((0,n.__)("Select publish date/time","cronicle"))}},(0,n.__)("Schedule","cronicle")),(0,e.createElement)("button",{className:"button cronicle-schedule-cancel",onClick:c},(0,n.__)("Cancel","cronicle")))))},D=({postData:a})=>{const{dispatch:s}=h(),[r,o]=(0,t.useState)(!1),[i,u]=(0,t.useState)(!1),[m,p]=(0,t.useState)(!1),[y,_]=(0,t.useState)(!1),[g,w]=(0,t.useState)({created:!1,published:!1,scheduled:!1});if(!a||!a.title||!a.content)return null;const f=a.is_outline?(0,n.__)("Create Outline Draft","cronicle"):(0,n.__)("Create Draft Post","cronicle");return(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"cronicle-preview-actions"},(0,e.createElement)("button",{className:"cronicle-preview-create-btn "+(g.created?"button-secondary":""),onClick:async()=>{o(!0);try{const e=await(async({title:e,content:t})=>E({action:"cronicle_create_post",title:e,content:t}))({title:a.title,content:a.content});e.success?(a.is_outline?(0,n.__)("✓ Outline Created","cronicle"):(0,n.__)("✓ Draft Created","cronicle"),w(e=>({...e,created:!0})),setTimeout(()=>{s({type:c,payload:{type:"assistant",content:`${e.data.message} Click here to edit it.`,timestamp:(new Date).getTime(),editUrl:e.data.edit_url}})},1e3),s({type:l,payload:null}),s({type:d,payload:!1})):alert(`Error creating post: ${e.data?.message||"Unknown error"}`)}catch(e){alert("Error creating post. Please try again.")}finally{o(!1)}},disabled:r||g.created},r?a.is_outline?(0,n.__)("Creating Outline...","cronicle"):(0,n.__)("Creating Draft...","cronicle"):g.created?a.is_outline?(0,n.__)("✓ Outline Created","cronicle"):(0,n.__)("✓ Draft Created","cronicle"):f),(0,e.createElement)("button",{className:"button button-primary cronicle-preview-publish-btn "+(g.published?"button-secondary":""),onClick:async()=>{u(!0);try{const e=await(async({title:e,content:t})=>E({action:"cronicle_publish_post",title:e,content:t}))({title:a.title,content:a.content});e.success?(w(e=>({...e,published:!0})),setTimeout(()=>{s({type:c,payload:{type:"assistant",content:`${e.data.message} Click here to view it.`,timestamp:(new Date).getTime(),viewUrl:e.data.view_url}})},1e3),s({type:l,payload:null}),s({type:d,payload:!1})):alert(`Error publishing post: ${e.data?.message||"Unknown error"}`)}catch(e){alert("Error publishing post. Please try again.")}finally{u(!1)}},disabled:i||g.published},i?(0,n.__)("Publishing...","cronicle"):g.published?(0,n.__)("✓ Post Published","cronicle"):(0,n.__)("Publish Now","cronicle")),(0,e.createElement)("button",{className:"button cronicle-preview-schedule-btn "+(g.scheduled?"button-secondary":""),onClick:()=>_(!0),disabled:m||g.scheduled},m?(0,n.__)("Scheduling...","cronicle"):g.scheduled?(0,n.__)("✓ Post Scheduled","cronicle"):(0,n.__)("Schedule","cronicle"))),y&&(0,e.createElement)(N,{onConfirm:async e=>{if(e){p(!0),_(!1);try{const t=await(async({title:e,content:t,scheduled_datetime:n})=>E({action:"cronicle_schedule_post",title:e,content:t,scheduled_datetime:n}))({title:a.title,content:a.content,scheduled_datetime:e});t.success?(w(e=>({...e,scheduled:!0})),setTimeout(()=>{s({type:c,payload:{type:"assistant",content:`${t.data.message} Click here to edit it.`,timestamp:(new Date).getTime(),editUrl:t.data.edit_url}})},1e3),s({type:l,payload:null}),s({type:d,payload:!1})):alert(`Error scheduling post: ${t.data?.message||"Unknown error"}`)}catch(e){alert("Error scheduling post. Please try again.")}finally{p(!1)}}else _(!1)},onCancel:()=>_(!1)}))},T=()=>{const{state:t,dispatch:a}=h();if(!t.showPreview||!t.currentDraft)return null;const c=t.currentDraft.is_outline?(0,n.__)("Post Outline Preview","cronicle"):(0,n.__)("Post Preview","cronicle");return(0,e.createElement)("div",{className:"cronicle-preview-container "+(t.showPreview?"active":"")},(0,e.createElement)("div",{className:"cronicle-preview-header"},(0,e.createElement)("span",{className:"cronicle-preview-title"},c),(0,e.createElement)("button",{className:"cronicle-preview-close-btn",onClick:()=>{a({type:d,payload:!1})},"aria-label":(0,n.__)("Close preview","cronicle")},"×")),(0,e.createElement)(S,{postData:t.currentDraft}),(0,e.createElement)(D,{postData:t.currentDraft}))},P=()=>{const[a,c]=(0,t.useState)(!1),[l,s]=(0,t.useState)(!0);return(0,t.useEffect)(()=>{const e=()=>{window.cronicle_ajax?(c(!!window.cronicle_ajax.api_configured),s(!1)):setTimeout(e,100)};e()},[]),l?(0,e.createElement)("div",null,"Loading..."):a?(0,e.createElement)(_,null,(0,e.createElement)("div",{className:"wrap"},(0,e.createElement)("div",{className:"cronicle-container"},(0,e.createElement)(g,{isApiConfigured:!0}),(0,e.createElement)("div",{className:"cronicle-main-content"},(0,e.createElement)(C,null),(0,e.createElement)(T,null))))):(0,e.createElement)("div",{className:"wrap"},(0,e.createElement)("div",{className:"cronicle-container"},(0,e.createElement)(g,{isApiConfigured:!1}),(0,e.createElement)("div",{className:"cronicle-setup-notice"},(0,e.createElement)("p",null,(0,e.createElement)("strong",null,(0,n.__)("Welcome to Cronicle!","cronicle")),(0,e.createElement)("br",null),(0,n.__)("To get started, you need to configure your Anthropic API key.","cronicle")),(0,e.createElement)("p",null,(0,e.createElement)("a",{href:`${window.location.origin}/wp-admin/options-general.php?page=cronicle-settings`,className:"button button-primary"},(0,n.__)("Configure API Key","cronicle"))))))};document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("cronicle-react-root");n&&(0,t.render)((0,e.createElement)(P,null),n)})})();