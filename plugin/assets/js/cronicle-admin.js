(()=>{"use strict";const e=window.React,t=window.wp.element,n=window.wp.i18n,a={messages:[],currentDraft:null,currentSessionId:null,selectedMode:"draft",selectedTemplate:"auto",enabledContextProviders:{site:!0,user:!0,writing_style:!0,content:!1,conversation:!1},isTyping:!1,isSending:!1,showPreview:!1,showWelcome:!0},c="ADD_MESSAGE",l="SET_CURRENT_DRAFT",o="SET_SESSION_ID",r="SET_MODE",s="SET_TEMPLATE",i="SET_CONTEXT_PROVIDER",d="SET_TYPING",u="SET_SENDING",m="SET_SHOW_PREVIEW",p="CLEAR_MESSAGES",y="LOAD_MESSAGES",_=(e,t)=>{switch(t.type){case c:return{...e,messages:[...e.messages,t.payload],showWelcome:!1};case l:return{...e,currentDraft:t.payload};case o:return{...e,currentSessionId:t.payload};case r:return{...e,selectedMode:t.payload};case s:return{...e,selectedTemplate:t.payload};case i:return{...e,enabledContextProviders:{...e.enabledContextProviders,[t.payload.provider]:t.payload.enabled}};case d:return{...e,isTyping:t.payload};case u:return{...e,isSending:t.payload};case m:return{...e,showPreview:t.payload};case"SET_SHOW_WELCOME":return{...e,showWelcome:t.payload};case p:return{...e,messages:[],currentDraft:null,showWelcome:!0,showPreview:!1};case y:return{...e,messages:t.payload,showWelcome:0===t.payload.length};default:return e}},E=(0,t.createContext)(),h=({children:n})=>{const[c,l]=(0,t.useReducer)(_,a);return(0,e.createElement)(E.Provider,{value:{state:c,dispatch:l}},n)},g=()=>{const e=(0,t.useContext)(E);if(!e)throw new Error("useCronicle must be used within a CronicleProvider");return e},w=async e=>(await fetch(window.cronicle_ajax.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({...e,nonce:window.cronicle_ajax.nonce})})).json(),v=({isApiConfigured:t})=>{let a={selectedMode:"draft"},l=()=>{};if(t)try{const e=g();a=e.state,l=e.dispatch}catch(e){}return(0,e.createElement)("div",{className:"cronicle-header"},(0,e.createElement)("h1",null,(0,n.__)("Cronicle AI Assistant","cronicle")),(0,e.createElement)("div",{className:"cronicle-header-right"},t&&(0,e.createElement)("div",{className:"cronicle-session-controls"},(0,e.createElement)("button",{type:"button",className:"button cronicle-new-session-btn",onClick:async()=>{if(window.confirm((0,n.__)("Start a new chat session? This will clear the current conversation.","cronicle")))try{const e=await(async()=>w({action:"cronicle_start_new_session"}))();e.success&&(l({type:o,payload:e.data.session_id}),l({type:p}),l({type:c,payload:{type:"system",content:e.data.message,timestamp:(new Date).getTime()}}),setTimeout(()=>{},2e3))}catch(e){alert((0,n.__)("Could not start new session. Please try again.","cronicle"))}}},(0,n.__)("New Chat","cronicle"))),(0,e.createElement)("span",{className:"cronicle-status "+(t?"connected":"disconnected")},t?(0,n.__)("Connected","cronicle"):(0,n.__)("Not Connected","cronicle"))))},f=({postData:a,onPreview:c,fromHistory:o})=>{const{dispatch:r}=g();return(0,t.useEffect)(()=>{if(!o&&a){const e=setTimeout(()=>{r({type:l,payload:a}),r({type:m,payload:!0})},500);return()=>clearTimeout(e)}},[a,o,r]),(0,e.createElement)("div",{className:"cronicle-post-actions"},(0,e.createElement)("button",{className:"button button-secondary",onClick:c,style:{padding:"8px 16px",fontSize:"13px"}},(0,n.__)("Preview","cronicle")))},b=({message:t})=>{const{dispatch:n}=g();return"system"===t.type?(0,e.createElement)("div",{className:"cronicle-message system"},(0,e.createElement)("div",{className:"cronicle-message-content"},(0,e.createElement)("em",null,t.content)),(0,e.createElement)("div",{style:{clear:"both"}})):(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:`cronicle-message ${t.type}`},(0,e.createElement)("div",{className:"cronicle-message-content"},t.content,t.is_post_content&&t.post_data&&(0,e.createElement)(f,{postData:t.post_data,onPreview:()=>{t.post_data&&(n({type:l,payload:t.post_data}),n({type:m,payload:!0}))},fromHistory:t.fromHistory}))),(0,e.createElement)("div",{style:{clear:"both"}}))},C=({messages:n})=>{const a=(0,t.useRef)(null);return(0,t.useEffect)(()=>{a.current?.scrollIntoView({behavior:"smooth"})},[n]),(0,e.createElement)("div",{className:"cronicle-messages"},n.map((t,n)=>(0,e.createElement)(b,{key:`${t.timestamp||Date.now()}-${n}`,message:t})),(0,e.createElement)("div",{ref:a}))},N=()=>{const{state:a,dispatch:o}=g(),[m,p]=(0,t.useState)(""),[y,_]=(0,t.useState)(!1),E=(0,t.useRef)(null),h=()=>{const e=E.current;if(!e)return;e.style.height="auto";let t=e.scrollHeight;if(!m){const n=document.createElement("div"),a=window.getComputedStyle(e);n.style.position="absolute",n.style.visibility="hidden",n.style.padding=a.padding,n.style.width=a.width,n.style.fontFamily=a.fontFamily,n.style.fontSize=a.fontSize,n.style.lineHeight=a.lineHeight,n.style.whiteSpace="pre-wrap",n.style.wordWrap="break-word",n.textContent=e.placeholder,document.body.appendChild(n),t=n.scrollHeight,document.body.removeChild(n)}const n=Math.min(t,300);e.style.height=`${n}px`,e.style.overflowY=t>300?"auto":"hidden"};(0,t.useEffect)(()=>{h()},[m]),(0,t.useEffect)(()=>{if(E.current){const e="outline"===a.selectedMode?(0,n.__)("What topic would you like an outline for? (e.g., benefits of exercise, cooking tips, travel destinations)","cronicle"):(0,n.__)("What would you like to write about? (e.g., benefits of exercise, cooking tips, travel destinations)","cronicle");E.current.placeholder=e,h()}},[a.selectedMode]);const v=async e=>{e.preventDefault();const t=m.trim();if(t&&!a.isSending){o({type:c,payload:{type:"user",content:t,timestamp:(new Date).getTime()}}),p(""),o({type:u,payload:!0}),o({type:d,payload:!0});try{let e;if(e=a.currentDraft?await(async({title:e,content:t,instructions:n})=>w({action:"cronicle_revise_draft",title:e,content:t,instructions:n}))({title:a.currentDraft.title,content:a.currentDraft.content,instructions:t}):await(async({message:e,mode:t})=>w({action:"cronicle_chat_message",message:e,mode:t}))({message:t,mode:a.selectedMode||"draft",template:a.selectedTemplate||"auto",context_providers:a.enabledContextProviders}),e.success&&e.data.content){const t={type:"assistant",content:e.data.content,timestamp:(new Date).getTime(),is_post_content:e.data.is_post_content||!1,post_data:e.data.post_data||null};o({type:c,payload:t}),e.data.is_post_content&&e.data.post_data&&o({type:l,payload:e.data.post_data})}else{const t=e.data?.message||(0,n.__)("Error sending message. Please try again.","cronicle");o({type:c,payload:{type:"assistant",content:`Error: ${t}`,timestamp:(new Date).getTime()}})}}catch(e){o({type:c,payload:{type:"assistant",content:`Error: ${(0,n.__)("Error sending message. Please try again.","cronicle")}`,timestamp:(new Date).getTime()}})}finally{o({type:u,payload:!1}),o({type:d,payload:!1}),E.current&&E.current.focus()}}},f=e=>t=>{o({type:i,payload:{provider:e,enabled:t.target.checked}})};return(0,e.createElement)("div",{className:"cronicle-input-area"},(0,e.createElement)("div",{className:"cronicle-input-options"},(0,e.createElement)("div",{className:"cronicle-input-options-main"},(0,e.createElement)("div",{className:"cronicle-option-group"},(0,e.createElement)("label",{htmlFor:"cronicle-input-mode"},(0,n.__)("Mode:","cronicle")),(0,e.createElement)("select",{id:"cronicle-input-mode",className:"cronicle-input-option-select",value:a.selectedMode||"draft",onChange:e=>{o({type:r,payload:e.target.value})}},(0,e.createElement)("option",{value:"draft"},(0,n.__)("Full Draft","cronicle")),(0,e.createElement)("option",{value:"outline"},(0,n.__)("Outline","cronicle")))),(0,e.createElement)("div",{className:"cronicle-option-group"},(0,e.createElement)("label",{htmlFor:"cronicle-input-template"},(0,n.__)("Template:","cronicle")),(0,e.createElement)("select",{id:"cronicle-input-template",className:"cronicle-input-option-select",value:a.selectedTemplate||"auto",onChange:e=>{o({type:s,payload:e.target.value})}},(0,e.createElement)("option",{value:"auto"},(0,n.__)("Auto","cronicle")),(0,e.createElement)("option",{value:"blog-post-professional"},(0,n.__)("Professional","cronicle")),(0,e.createElement)("option",{value:"blog-post-casual"},(0,n.__)("Casual","cronicle")),(0,e.createElement)("option",{value:"content-outline"},(0,n.__)("Outline","cronicle")),(0,e.createElement)("option",{value:"how-to-guide"},(0,n.__)("How-to","cronicle")),(0,e.createElement)("option",{value:"listicle"},(0,n.__)("List","cronicle")))),(0,e.createElement)("button",{type:"button",className:"button button-small cronicle-options-toggle",onClick:()=>_(!y)},y?(0,n.__)("Less","cronicle"):(0,n.__)("More","cronicle"))),y&&(0,e.createElement)("div",{className:"cronicle-input-context-options"},(0,e.createElement)("span",{className:"cronicle-context-label"},(0,n.__)("Include:","cronicle")),(0,e.createElement)("div",{className:"cronicle-context-checkboxes-inline"},Object.entries(a.enabledContextProviders||{}).map(([t,a])=>(0,e.createElement)("label",{key:t,className:"cronicle-context-checkbox-inline"},(0,e.createElement)("input",{type:"checkbox",checked:a,onChange:f(t)}),(0,e.createElement)("span",null,"writing_style"===t?(0,n.__)("Style","cronicle"):"conversation"===t?(0,n.__)("Chat","cronicle"):(0,n.__)(t.charAt(0).toUpperCase()+t.slice(1),"cronicle"))))))),(0,e.createElement)("form",{className:"cronicle-input-form",onSubmit:v},(0,e.createElement)("textarea",{ref:E,className:"cronicle-input",value:m,onChange:e=>{p(e.target.value)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),v(e))},placeholder:"outline"===a.selectedMode?(0,n.__)("What topic would you like an outline for?","cronicle"):(0,n.__)("What would you like to write about?","cronicle"),rows:"1"}),(0,e.createElement)("button",{type:"submit",className:"cronicle-send-button",disabled:a.isSending},a.isSending?(0,n.__)("Sending...","cronicle"):(0,n.__)("Send","cronicle"))))},S=()=>{const{state:a,dispatch:c}=g();return(0,t.useEffect)(()=>{(async()=>{try{const e=await(async()=>w({action:"cronicle_load_chat_history"}))();e.success&&e.data.messages&&(c({type:o,payload:e.data.session_id}),c({type:y,payload:e.data.messages}))}catch(e){console.log("Could not load chat history:",e)}})()},[c]),(0,e.createElement)("div",{className:"cronicle-chat-container"},a.showWelcome&&(0,e.createElement)("div",{className:"cronicle-welcome-message"},(0,n.__)("Create a new draft with AI","cronicle")),(0,e.createElement)(C,{messages:a.messages}),a.isTyping&&(0,e.createElement)("div",{className:"cronicle-typing-indicator"},(0,n.__)("Assistant is typing...","cronicle")),(0,e.createElement)(N,null))},T=({postData:t})=>{if(!t||!t.title||!t.content)return null;const n=(e=>{const t=document.createElement("div");t.innerHTML=e;let n="";return t.querySelectorAll("*").forEach(e=>{const t=e.tagName.toLowerCase(),a=e.textContent.trim();if(a)switch(t){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":n+=`<${t}>${a}</${t}>`;break;case"p":n+=`<p>${a}</p>`;break;case"ul":n+="<ul>",e.querySelectorAll("li").forEach(e=>{n+=`<li>${e.textContent}</li>`}),n+="</ul>";break;case"ol":n+="<ol>",e.querySelectorAll("li").forEach(e=>{n+=`<li>${e.textContent}</li>`}),n+="</ol>"}}),n||(n=e.replace(/\n/g,"<br>")),n})(t.content);return(0,e.createElement)("div",{className:"cronicle-preview-content"},(0,e.createElement)("div",{className:"cronicle-preview-post"},(0,e.createElement)("h1",null,t.title),(0,e.createElement)("div",{dangerouslySetInnerHTML:{__html:n}})))},D=({onConfirm:a,onCancel:c})=>{const[l,o]=(0,t.useState)(""),r=(0,t.useRef)(null);return(0,t.useEffect)(()=>{r.current&&r.current.focus();const e=e=>{"Escape"===e.key&&c()};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[c]),(0,e.createElement)("div",{className:"cronicle-schedule-overlay",onClick:e=>{e.target===e.currentTarget&&c()}},(0,e.createElement)("div",{className:"cronicle-schedule-dialog"},(0,e.createElement)("label",{htmlFor:"schedule-datetime"},(0,n.__)("Select publish date/time","cronicle")),(0,e.createElement)("input",{ref:r,id:"schedule-datetime",type:"datetime-local",className:"cronicle-schedule-input",value:l,onChange:e=>o(e.target.value)}),(0,e.createElement)("div",{style:{display:"flex",gap:"8px",marginTop:"10px"}},(0,e.createElement)("button",{className:"button button-primary cronicle-schedule-confirm",onClick:()=>{l?a(l):alert((0,n.__)("Select publish date/time","cronicle"))}},(0,n.__)("Schedule","cronicle")),(0,e.createElement)("button",{className:"button cronicle-schedule-cancel",onClick:c},(0,n.__)("Cancel","cronicle")))))},P=({postData:a})=>{const{dispatch:o}=g(),[r,s]=(0,t.useState)(!1),[i,d]=(0,t.useState)(!1),[u,p]=(0,t.useState)(!1),[y,_]=(0,t.useState)(!1),[E,h]=(0,t.useState)({created:!1,published:!1,scheduled:!1});if(!a||!a.title||!a.content)return null;const v=a.is_outline?(0,n.__)("Create Outline Draft","cronicle"):(0,n.__)("Create Draft Post","cronicle");return(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"cronicle-preview-actions"},(0,e.createElement)("button",{className:"cronicle-preview-create-btn "+(E.created?"button-secondary":""),onClick:async()=>{s(!0);try{const e=await(async({title:e,content:t})=>w({action:"cronicle_create_post",title:e,content:t}))({title:a.title,content:a.content});e.success?(a.is_outline?(0,n.__)("✓ Outline Created","cronicle"):(0,n.__)("✓ Draft Created","cronicle"),h(e=>({...e,created:!0})),setTimeout(()=>{o({type:c,payload:{type:"assistant",content:`${e.data.message} Click here to edit it.`,timestamp:(new Date).getTime(),editUrl:e.data.edit_url}})},1e3),o({type:l,payload:null}),o({type:m,payload:!1})):alert(`Error creating post: ${e.data?.message||"Unknown error"}`)}catch(e){alert("Error creating post. Please try again.")}finally{s(!1)}},disabled:r||E.created},r?a.is_outline?(0,n.__)("Creating Outline...","cronicle"):(0,n.__)("Creating Draft...","cronicle"):E.created?a.is_outline?(0,n.__)("✓ Outline Created","cronicle"):(0,n.__)("✓ Draft Created","cronicle"):v),(0,e.createElement)("button",{className:"button button-primary cronicle-preview-publish-btn "+(E.published?"button-secondary":""),onClick:async()=>{d(!0);try{const e=await(async({title:e,content:t})=>w({action:"cronicle_publish_post",title:e,content:t}))({title:a.title,content:a.content});e.success?(h(e=>({...e,published:!0})),setTimeout(()=>{o({type:c,payload:{type:"assistant",content:`${e.data.message} Click here to view it.`,timestamp:(new Date).getTime(),viewUrl:e.data.view_url}})},1e3),o({type:l,payload:null}),o({type:m,payload:!1})):alert(`Error publishing post: ${e.data?.message||"Unknown error"}`)}catch(e){alert("Error publishing post. Please try again.")}finally{d(!1)}},disabled:i||E.published},i?(0,n.__)("Publishing...","cronicle"):E.published?(0,n.__)("✓ Post Published","cronicle"):(0,n.__)("Publish Now","cronicle")),(0,e.createElement)("button",{className:"button cronicle-preview-schedule-btn "+(E.scheduled?"button-secondary":""),onClick:()=>_(!0),disabled:u||E.scheduled},u?(0,n.__)("Scheduling...","cronicle"):E.scheduled?(0,n.__)("✓ Post Scheduled","cronicle"):(0,n.__)("Schedule","cronicle"))),y&&(0,e.createElement)(D,{onConfirm:async e=>{if(e){p(!0),_(!1);try{const t=await(async({title:e,content:t,scheduled_datetime:n})=>w({action:"cronicle_schedule_post",title:e,content:t,scheduled_datetime:n}))({title:a.title,content:a.content,scheduled_datetime:e});t.success?(h(e=>({...e,scheduled:!0})),setTimeout(()=>{o({type:c,payload:{type:"assistant",content:`${t.data.message} Click here to edit it.`,timestamp:(new Date).getTime(),editUrl:t.data.edit_url}})},1e3),o({type:l,payload:null}),o({type:m,payload:!1})):alert(`Error scheduling post: ${t.data?.message||"Unknown error"}`)}catch(e){alert("Error scheduling post. Please try again.")}finally{p(!1)}}else _(!1)},onCancel:()=>_(!1)}))},k=()=>{const{state:t,dispatch:a}=g();if(!t.showPreview||!t.currentDraft)return null;const c=t.currentDraft.is_outline?(0,n.__)("Post Outline Preview","cronicle"):(0,n.__)("Post Preview","cronicle");return(0,e.createElement)("div",{className:"cronicle-preview-container "+(t.showPreview?"active":"")},(0,e.createElement)("div",{className:"cronicle-preview-header"},(0,e.createElement)("span",{className:"cronicle-preview-title"},c),(0,e.createElement)("button",{className:"cronicle-preview-close-btn",onClick:()=>{a({type:m,payload:!1})},"aria-label":(0,n.__)("Close preview","cronicle")},"×")),(0,e.createElement)(T,{postData:t.currentDraft}),(0,e.createElement)(P,{postData:t.currentDraft}))},x=()=>{const[a,c]=(0,t.useState)(!1),[l,o]=(0,t.useState)(!0);return(0,t.useEffect)(()=>{const e=()=>{window.cronicle_ajax?(c(!!window.cronicle_ajax.api_configured),o(!1)):setTimeout(e,100)};e()},[]),l?(0,e.createElement)("div",null,"Loading..."):a?(0,e.createElement)(h,null,(0,e.createElement)("div",{className:"wrap"},(0,e.createElement)("div",{className:"cronicle-container"},(0,e.createElement)(v,{isApiConfigured:!0}),(0,e.createElement)("div",{className:"cronicle-main-content"},(0,e.createElement)(S,null),(0,e.createElement)(k,null))))):(0,e.createElement)("div",{className:"wrap"},(0,e.createElement)("div",{className:"cronicle-container"},(0,e.createElement)(v,{isApiConfigured:!1}),(0,e.createElement)("div",{className:"cronicle-setup-notice"},(0,e.createElement)("p",null,(0,e.createElement)("strong",null,(0,n.__)("Welcome to Cronicle!","cronicle")),(0,e.createElement)("br",null),(0,n.__)("To get started, you need to configure your Anthropic API key.","cronicle")),(0,e.createElement)("p",null,(0,e.createElement)("a",{href:`${window.location.origin}/wp-admin/options-general.php?page=cronicle-settings`,className:"button button-primary"},(0,n.__)("Configure API Key","cronicle"))))))};document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("cronicle-react-root");n&&(0,t.render)((0,e.createElement)(x,null),n)})})();